def getKeyword(keywords, messages)
  key = []
  start_datetime = DateTime.parse(@date)
  end_datetime = start_datetime.at_end_of_day()
  keywords.each do |keyword|
    messages.each do |message|
      if(message.body.start_with?("cod_"))
        cKye = message.body.split(",").last
        if(cKye == keyword && message && message.sent_at && start_datetime < message.sent_at && message.sent_at < end_datetime)
          key.append(keyword)
        end
      end
    end
  end
  key.join(", ")
end

def checkMessageDate(message)
  start_datetime = DateTime.parse(@date)
  end_datetime = start_datetime.at_end_of_day()
  if(message && message.sent_at)
    start_datetime < message.sent_at && message.sent_at < end_datetime
  else
    false
  end
end

def restOfMessages(messages, firstIndex)
  rest = []
  continue = true;
  messages.each_with_index do |message, index|
    if index > firstIndex && !message.body.start_with?("cod_") && continue
      rest.append(message.body)
    elsif index > firstIndex && message.body.start_with?("cod_")
      continue = false
    end
  end
  rest
end

wb = xlsx_package.workbook
head_style = wb.styles.add_style bg_color: "DDDDDD",  b: true
wb.use_autowidth = false
head = ["Keyword", "Phone number", @date]
rows = []

wb.add_worksheet(name: "Conversations") do |sheet|
  # Create the header row
  sheet.add_row head
  sheet.row_style 0, head_style
  widths = [20,20]
  @items.each do |item|
    row = [getKeyword(item.keywords, item.messages), item.client_phone_number]
    item.messages.each_with_index do |message, index|
      if checkMessageDate(message)
        row.append(message.body)
        if(row.size > widths.size)
          widths.append(40)
        end
      end
    end
      row.append(" ")
      sheet.add_row row
      row = []
  end
  sheet.column_widths(*widths)
end